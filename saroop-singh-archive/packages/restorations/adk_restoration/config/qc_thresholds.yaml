# ADK Restoration System - Quality Control Thresholds
# Defines quality gates and decision criteria for auto-retry and approval

# Overall Quality Thresholds
quality_gates:
  # Minimum scores to pass QC
  minimum_thresholds:
    overall_score: 65        # Main quality gate
    preservation: 70         # Historical accuracy preservation
    defect_removal: 60       # Defect/damage removal effectiveness
    enhancement: 55          # Enhancement quality
    naturalness: 65          # How natural the result looks
    technical_quality: 60    # Technical image quality (sharpness, exposure, etc.)

  # Target scores for good quality
  target_thresholds:
    overall_score: 80
    preservation: 85
    defect_removal: 80
    enhancement: 75
    naturalness: 80
    technical_quality: 75

  # Excellent quality thresholds
  excellent_thresholds:
    overall_score: 90
    preservation: 92
    defect_removal: 90
    enhancement: 88
    naturalness: 90
    technical_quality: 85

# Decision Rules for QC Outcomes
qc_decisions:
  auto_approve:
    conditions:
      overall_score: { min: 80 }
      preservation: { min: 75 }
      critical_failures: { max: 0 }
    action: "APPROVE"
    confidence: "high"

  conditional_approve:
    conditions:
      overall_score: { min: 65, max: 79 }
      preservation: { min: 60 }
      critical_failures: { max: 1 }
    action: "APPROVE_WITH_NOTES"  
    confidence: "medium"
    require_manual_review: false

  auto_retry:
    conditions:
      overall_score: { min: 40, max: 64 }
      preservation: { min: 50 }
      critical_failures: { max: 2 }
      retry_count: { max: 2 }
    action: "RETRY"
    confidence: "low"

  manual_review:
    conditions:
      overall_score: { min: 30, max: 64 }
      preservation: { min: 40 }
      critical_failures: { max: 3 }
      retry_count: { min: 3 }
    action: "MANUAL_REVIEW"
    confidence: "low"

  auto_reject:
    conditions:
      overall_score: { max: 29 }
      preservation: { max: 39 }
      critical_failures: { min: 4 }
    action: "REJECT"
    confidence: "high"

# Retry Configuration
retry_policies:
  max_attempts: 3
  
  # Parameter adjustments for retries
  parameter_adjustments:
    attempt_1:
      temperature_delta: -0.1      # More conservative
      steps_modification: "remove_risky"
      focus_areas: ["preservation", "defect_removal"]
      
    attempt_2:
      temperature_delta: -0.2      # Even more conservative  
      steps_modification: "simplify_approach"
      focus_areas: ["preservation"]
      
    attempt_3:
      temperature_delta: -0.3      # Most conservative
      steps_modification: "basic_restoration_only"
      focus_areas: ["preservation", "basic_cleanup"]

  # Escalation rules
  escalation:
    after_3_failures: "manual_review"
    quality_degradation: "stop_retries"
    critical_defect_introduction: "immediate_manual_review"

# Quality Scoring Weights
scoring_weights:
  overall_calculation:
    preservation: 0.30        # 30% weight - most important
    defect_removal: 0.25      # 25% weight
    naturalness: 0.20         # 20% weight  
    technical_quality: 0.15   # 15% weight
    enhancement: 0.10         # 10% weight

  # Mode-specific weight adjustments
  mode_adjustments:
    RESTORE:
      preservation: 0.40      # Higher preservation weight
      enhancement: 0.05       # Lower enhancement weight
      
    ENHANCE:
      preservation: 0.25      # Standard preservation
      enhancement: 0.15       # Higher enhancement weight
      technical_quality: 0.20 # Higher technical quality
      
    REIMAGINE:
      preservation: 0.20      # Lower preservation (more creative freedom)
      enhancement: 0.25       # Much higher enhancement
      naturalness: 0.15       # Allow more artistic interpretation

# Critical Failure Definitions
critical_failures:
  preservation_loss:
    description: "Significant loss of historical authenticity"
    threshold: 
      preservation_score: { max: 40 }
      historical_accuracy: { max: 30 }
    severity: "high"
    
  face_distortion:
    description: "Distortion of facial features in portraits"
    threshold:
      face_quality_score: { max: 50 }
    severity: "critical"
    applies_to: ["portrait", "group_photo"]
    
  color_failure:
    description: "Unnatural or historically inaccurate colors"
    threshold:
      color_accuracy: { max: 40 }
      naturalness: { max: 45 }
    severity: "medium"
    
  artifact_introduction:
    description: "Introduction of new defects or artifacts"
    threshold:
      technical_quality: { decrease: 20 }  # 20 point decrease from original
    severity: "high"
    
  text_corruption:
    description: "Corruption of readable text in documents"
    threshold:
      text_readability: { max: 30 }
    severity: "critical"
    applies_to: ["document"]

# Batch Processing Thresholds
batch_processing:
  quality_gates:
    batch_average_score: 70           # Average quality across batch
    failure_rate: { max: 0.15 }       # Max 15% failure rate
    manual_review_rate: { max: 0.10 } # Max 10% requiring manual review
    
  stop_conditions:
    consecutive_failures: 5           # Stop after 5 consecutive failures
    critical_failure_rate: { max: 0.05 } # Stop if >5% critical failures
    average_score_degradation: 15     # Stop if average drops by 15 points

# Alert Thresholds  
alerts:
  quality_degradation:
    rolling_average_window: 20        # Last 20 processed images
    degradation_threshold: 10         # Alert if average drops 10 points
    
  failure_rate_spike:
    window_size: 10                   # Last 10 images  
    failure_rate_threshold: 0.30      # Alert if >30% failure rate
    
  critical_failure_alert:
    any_critical_failure: true        # Alert on any critical failure
    multiple_critical_threshold: 2    # Escalate if 2+ critical failures

# Performance Thresholds
performance:
  processing_time:
    max_per_step: 45                  # Seconds per restoration step
    max_total: 600                    # Seconds total per image (10 minutes)
    timeout_action: "manual_review"
    
  resource_usage:
    max_memory_mb: 2048              # Max memory usage
    max_cpu_percent: 80              # Max CPU usage
    
  api_rate_limits:
    gemini_requests_per_minute: 60    # Gemini API rate limit
    airtable_requests_per_second: 5   # Airtable API rate limit
    cloudinary_uploads_per_hour: 500  # Cloudinary upload limit